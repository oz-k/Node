<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        #area {
            width : 600px;
            height : 300px;
            border: 1px solid black;
            resize: none;
            overflow: auto;
        }
        #users {
            width : 300px;
            margin-top: 16px;
            margin-right: 50px;
            text-align: center;
        }
        .test {
            display: flex;
        }
        #area div {
            word-break: break-all;
        }
        #area div img {
            max-width : 253px;
        }
        #label {
            margin-left: 10px;
            border: 1px solid black;
        }
        #send, #image {
            visibility: hidden;
        }
        #video {
            display: flex;
        }
        #video video {
            transform: rotateY(180deg);
            -webkit-transform: rotateY(180deg);
            -moz-transform: rotateY(180deg);
            margin-right : 10px;
            border: 1px solid black;
        }
    </style>
</head>
<body>
    <script>
        var from = '<%=userid%>';
    </script>
    <strong id="name"><%=username%></strong>
    <form action="">
        <input type="submit" value="회원탈퇴">
        <input type="button" onclick="script:location.href='/logout'" value="로그아웃">
    </form>
    <div class="test">
        <div id="users"></div>
        <div id='dd'>
        </div>
    </div>

    <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
    <script src="https://code.jquery.com/jquery-1.10.2.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="/script/webRTC.js"></script>
    <script>
        //소켓
        var socket = io();
        var to;
        var peerid;
        const peer = new Peer()
        socket.emit('join', {'from':from, 'to':to});
        //접속자
        peer.on('open', function(id) {
            peerid = id;

            socket.emit('show lawyer', );
            socket.on('lawyer', function(lawyer) {
                //document.getElementById('users').innerText = '변호사 목록\n----------\n';
                lawyer.forEach(i => {
                    var userid = i.userId;
                    var node = document.createElement('p');
                    node.innerHTML = i.name+" <button id='"+userid+"'>채팅하기</button>"//i.name+" 변호사 <button id='"+userid+"'>채팅하기</button>"
                    document.getElementById('users').appendChild(node);
                    document.getElementById(userid).addEventListener('click', function() {
                        to = userid;
                        createView();
                        socket.emit('p2poff', );
                    });
                });
            });
            //메시지 받기
            socket.on('getmsg', function(msg) {
                if(msg.from === to) {
                    if(msg.type === 'msg') {
                        var node = document.createElement("div");
                        node.innerText = msg.msg.name+" : "+msg.msg.msg;
                        document.getElementById('area').appendChild(node);
                        document.getElementById('area').scrollTop = document.getElementById('area').scrollHeight;
                    } else if(msg.type === 'img') {
                        var img = document.createElement('img');
                        img.setAttribute('src', 'data:image/png;base64,'+msg.msg.img);
                        var div = document.createElement('div');
                        div.innerText = msg.msg.name+" : ";
                        div.appendChild(img);
                        document.getElementById('area').appendChild(div);
                        document.getElementById('area').scrollTop = document.getElementById('area').scrollHeight;
                    }
                }
            });
        })
        
        function createView() {
            if(document.getElementById('main')) {
                document.getElementById('dd').removeChild(document.getElementById('video'));
                document.getElementById('dd').removeChild(document.getElementById('main'));
            }
            var parent = document.createElement('div');
            parent.setAttribute('id', 'video');
            var div = document.createElement('div');
            var p = document.createElement('p');
            p.innerText = '내 화면';
            div.appendChild(p);
            var video = document.createElement('video');
            video.setAttribute('id', 'localVideo');
            video.setAttribute('width', '480px');
            video.setAttribute('autoplay', "");
            div.appendChild(video);
            parent.appendChild(div);
            div = document.createElement('div');
            p = document.createElement('p');
            p.innerText = '상대 화면';
            div.appendChild(p);
            video = document.createElement('video');
            video.setAttribute('id', 'remoteVideo');
            video.setAttribute('width', '480px');
            video.setAttribute('autoplay', "");
            div.appendChild(video);
            parent.appendChild(div);
            document.getElementById('dd').appendChild(parent);

            createChat();
        }
        function createChat() {
            var area = document.createElement('div');
            var p = document.createElement('p');
            area.setAttribute('id', 'area');
            p.appendChild(area);
            var div = document.createElement('div');
            div.setAttribute('id', 'main');
            div.appendChild(p);
            var input = document.createElement('input');
            input.setAttribute('type', 'text');
            input.setAttribute('id', 'text');
            p = document.createElement('p');
            p.appendChild(input);
            var label = document.createElement('label');
            label.setAttribute('for', 'image');
            label.setAttribute('id', 'label');
            label.innerText = '이미지';
            p.appendChild(label);
            label = document.createElement('label');
            label.setAttribute('for', 'send');
            label.setAttribute('id', 'label');
            label.innerText = '보내기';
            p.appendChild(label);
            div.appendChild(p);
            var button = document.createElement('button');
            button.setAttribute('type', 'button');
            button.setAttribute('id', 'send');
            button.innerText = '보내기';
            div.appendChild(button);
            input = document.createElement('input');
            input.setAttribute('type', 'file');
            input.setAttribute('id', 'image');
            input.setAttribute('accept', 'image/*');
            div.appendChild(input);
            document.getElementById('dd').appendChild(div);

            //엔터전송
            document.getElementById('text').addEventListener('keyup', function(event) {
                if(event.keyCode === 13) {
                    event.preventDefault();
                    document.getElementById('send').click();
                }
            });

            //텍스트 전송
            document.getElementById('send').addEventListener('click', function() {
                var msg = document.getElementById('text').value;
                if(msg) {
                    socket.emit('setmsg', {'type':'msg', 'msg':msg, 'from':from, 'to':to, 'lawyer':false});
                    var node = document.createElement("div");
                    node.innerText = document.getElementById('name').innerText+" : "+msg;
                    node.setAttribute("style", "text-align:right;");
                    document.getElementById('area').appendChild(node);
                    document.getElementById('area').scrollTop = document.getElementById('area').scrollHeight;
                }
                document.getElementById('text').value = "";
                document.getElementById('text').focus();
                
            });

            //이미지 전송
            document.getElementById('image').addEventListener('change', function() {
                var img = $('#image')[0].files;
                var reader = new FileReader();
                reader.onload = function(event) {
                    var bin = event.target.result;
                    socket.emit('setmsg', {'type':'img', 'msg':btoa(bin), 'from':from, 'to':to, 'lawyer':false});
                    $('#image').val("");
                    var node = document.createElement('img');
                    node.setAttribute('src', 'data:image/png;base64,'+btoa(bin));
                    var div = document.createElement('div');
                    div.setAttribute("style", "text-align:right;");
                    div.innerText = document.getElementById('name').innerText+" : ";
                    div.appendChild(node);
                    document.getElementById('area').appendChild(div);
                    document.getElementById('area').scrollTop = document.getElementById('area').scrollHeight;
                }
                reader.readAsBinaryString(img[0]);
            })
            peerConnect(socket, peer, from, to, peerid);
        }
    </script>
</body>
</html>